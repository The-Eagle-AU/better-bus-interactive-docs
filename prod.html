<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nine Better Bus routes are coming to AU and Tenleytown</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 1.25rem;
            font-family: "Inter", sans-serif;
            background-color: #f5f5f5; }

        .container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            max-width: 75rem;
            margin: 0 auto;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.625rem rgba(0,0,0,0.1);
            overflow: hidden; }

        .header {
            padding: 1.25rem;
            background: #961e28;
            color: white; }

        .header h1 {
            margin: 0 0 0.625rem 0;
            font-size: 1.5rem; }

        .header p {
            margin: 0;
            opacity: 0.9; }

        .map-container {
            flex: 3;
            aspect-ratio: 16/9; }

        #map {
            height: 100%;
            width: 100%; }

        /* Ensure proper layout on smaller screens */
        @media (max-width: 768px) {
          .container { flex-direction: column; }

            .map-container { aspect-ratio: auto; }

          /* Set a fixed height for the map on smaller screens */
            #map { height: 18.75rem; }
        }

        .legend {
            background: white;
            padding: 1rem;
            border-radius: 0.25rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
            max-height: 12.5rem;
            overflow-y: auto; }

        .legend-header {
            background: white;
            padding: 0 0 0 1rem;
            border-radius: 0.25rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
            max-height: 12.5rem;
            overflow-y: auto; }

        .legend-header h3 {
            margin: 0 0 0.625rem 0;
            font-size: 1.25rem;
            color: #961e28; }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-radius: 0.1875rem;
            transition: background-color 0.2s; }

        .legend-item:hover {
            background-color: #f8f9fa; }

        .legend-color {
            width: 1.25rem;
            height: 0.25rem;
            margin-right: 0.625rem;
            border-radius: 0.125rem; }

        .legend-text {
            font-size: 0.875rem;
            color: rgba(52, 73, 94, 1); }

        .tooltip {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            border: none;
            box-shadow: 0 0.375rem 0.625rem rgba(0,0,0,0.3);
            max-width: 15.625rem;
            z-index: 1000;
            pointer-events: none; }

        .instructions {
            background: #e8f4f8;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            border-left: 0.25rem solid #3498db; }

        .instructions h4 {
            margin: 0 0 0.5rem 0;
            color: #2980b9; }

        .instructions p {
            margin: 0;
            font-size: 0.875rem;
            color: #34495e; }

        mark {
            background-color: #2980b9;
            color: whitesmoke;
            font-weight: bold; }
        mark.red { background-color: #d83e26; }
        mark.purple { background-color: #8e44ad; }

        a { color: #34495e }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Nine Better Bus routes are coming to AU and Tenleytown</h1>
            <p>Hover over routes to see details. Scroll to zoom. Click and grab to move around the map.</p>
        </div>
        <div class="map-container">
        <div id="map"></div>
        </div>
            <div class="legend-header" id="legend">
                <p style="font-size: 0.875rem;">Interactive map by Owen Auston-Babcock/The Eagle • Source:
                    <a target="_blank" rel="noopener noreferrer" href="https://developer.wmata.com/api-details#api=gtfs&operation=bus-gtfs-static-bbnr-qa">WMATA</a>
                    • <a target="_blank" rel="noopener noreferrer" href="https://github.com/The-Eagle-AU/better-bus-interactive-docs">Documentation</a></p>
                <h3>Routes</h3>
                <p style="font-style: italic; font-size: 0.875rem">Routes in <mark>blue</mark> run through Tenleytown. Those in <mark class="purple">purple</mark> connect Tenleytown and AU's main campus. The <mark class="red">D96, in red,</mark> runs through main campus but not Tenleytown.</p>
            </div>
            <div class="legend">
                <div id="legendContent">
                    <!-- Legend items will be populated here -->
                </div>
            </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="api_key.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([38.9072, -77.0369], zoom = 12);

        var corner1 = L.latLng(38.969326909563726, -77.15569548603933),
            corner2 = L.latLng(38.88791401887758, -76.96529859085035),
            bounds = L.latLngBounds(corner1, corner2);

        map.fitBounds(bounds);

        // Add MapTiler Street basemap
        L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${key}`, {
            attribution: '© MapTiler © OpenStreetMap contributors',
            maxZoom: 20
        }).addTo(map);

        let routeLayers = [];
        let currentGeoJSON = null;

        // Default colors for routes without specified colors
        const defaultColors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12',
            '#9b59b6', '#1abc9c', '#34495e', '#e67e22',
            '#8e44ad', '#27ae60', '#2980b9', '#c0392b' ];

        function getRouteColor(feature, index) {
            if (feature.properties.route_color) {
                // Ensure color starts with #
                const color = feature.properties.route_color;
                return color.startsWith('#') ? color : '#' + color; }
            return defaultColors[index % defaultColors.length]; }

        function createTooltipContent(feature) {
            const props = feature.properties;
            let content = `<strong>${props.route_short_name || props.route_id}</strong>`;

            if (props.route_long_name) {
                content += `<br/>${props.route_long_name}`; }

            return content; }

        function addRouteToMap(feature, index) {
            const color = getRouteColor(feature, index);

            const layer = L.geoJSON(feature, {
                style: {
                    color: color,
                    weight: 4,
                    opacity: 0.7,
                    lineCap: 'round',
                    lineJoin: 'round' } });

            // Add hover effects
            layer.on('mouseover', function(e) {
                const hoveredLayer = e.target;
                hoveredLayer.setStyle({
                    weight: 6,
                    opacity: 1 });

                // Dim other routes
                routeLayers.forEach(otherLayer => {
                    if (otherLayer !== hoveredLayer) {
                        otherLayer.setStyle({
                            opacity: 0.3 }); } });

                hoveredLayer.bringToFront(); });

            layer.on('mouseout', function(e) {
                // Reset all routes to normal style
                routeLayers.forEach(routeLayer => {
                    routeLayer.setStyle({
                        weight: 4,
                        opacity: 0.7 }); }); });

            // Add tooltip with smart positioning
            layer.bindTooltip(createTooltipContent(feature), {
                permanent: false,
                direction: 'auto',
                className: 'tooltip',
                sticky: true,
                offset: [10, -10] });

            layer.addTo(map);
            routeLayers.push(layer);

            return { layer, color };
        }

        function updateLegend(features) {
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';

            features.forEach((feature, index) => {
                const color = getRouteColor(feature, index);
                const props = feature.properties;

                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;

                const text = document.createElement('div');
                text.className = 'legend-text';
                text.textContent = `${props.route_short_name || props.route_id} - ${props.route_long_name || 'Route'}`;

                legendItem.appendChild(colorBox);
                legendItem.appendChild(text);
                legendContent.appendChild(legendItem);

                // Add click to highlight functionality
                legendItem.addEventListener('click', () => {
                    const targetLayer = routeLayers[index];
                    if (targetLayer) {
                        // Temporarily highlight the selected route
                        routeLayers.forEach(layer => {
                            layer.setStyle({ opacity: 0.3 }); });
                        targetLayer.setStyle({
                            opacity: 1,
                            weight: 6 });
                        targetLayer.bringToFront();

                        // Reset after 2 seconds
                        setTimeout(() => {
                            routeLayers.forEach(layer => {
                                layer.setStyle({
                                    opacity: 0.7,
                                    weight: 4 }); }); }, 2000);
                    }
                });
            });
        }

        function loadGeoJSON(geojsonData) {
            // Clear existing routes
            routeLayers.forEach(layer => {
                map.removeLayer(layer); });
            routeLayers = [];

            if (!geojsonData || !geojsonData.features) {
                console.error('Invalid GeoJSON data');
                return; }

            currentGeoJSON = geojsonData;

            // Add each route to the map
            geojsonData.features.forEach((feature, index) => {
                addRouteToMap(feature, index); });

            // Update legend
            updateLegend(geojsonData.features);

            // Fit map to show all routes
            if (routeLayers.length > 0) {
                const group = new L.featureGroup(routeLayers);
                map.fitBounds(group.getBounds().pad(0.1)); }
        }

        // Load sample data initially (or load from file)
        // To load from a .geojson file instead, uncomment the following lines:
        loadGeoJSONFromFile('../assets/better_bus_au_routes.geojson');

        // Function to load GeoJSON from a file
        async function loadGeoJSONFromFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`); }
                const geojsonData = await response.json();
                loadGeoJSON(geojsonData);
            } catch (error) {
                console.error('Error loading GeoJSON file:', error);
                alert('Could not load GeoJSON file. Using sample data instead.');
                loadGeoJSON(sampleGeoJSON); }
        }
    </script>
</body>
</html>